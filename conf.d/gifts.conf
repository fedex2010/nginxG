# Gifts new frontends development environments
server {
        include /etc/nginx/env.conf;
        include /etc/nginx/proxy_env.conf;

        listen 80;
        server_name gifts-ci.garbarino.com gifts-staging.garbarino.com;
        set $webstore Garbarino;
        # For user multimedia resources upload
        client_max_body_size 10M;

        include /etc/nginx/includes/headers;
        include /etc/nginx/includes/security;

        ######################### gifts-frontend #########################
        location / {
            proxy_pass $gifts_frontend_us;
        }

        ######################### gifts-dashboard #########################
        location /panel {
            proxy_pass $gifts_dashboard_us;
            client_max_body_size 10M;
        }
}

# Gifts production environment
server {
        include /etc/nginx/env.conf;
        include /etc/nginx/proxy_env.conf;

        listen 80;
        server_name listas.garbarino.com;
        set $webstore Garbarino;
        # For user multimedia resources upload
        client_max_body_size 10M;

        include /etc/nginx/includes/headers;
        include /etc/nginx/includes/security;

        location / {
            proxy_pass $gifts_frontend_us;
        }

        # Sign up, create list and contact routes
        location ~ ^(/ingresar.php|/logout.php|/crea_tu_lista.php|/contacto_listas_new.php|/lista_creada_ok.php)$ {
            proxy_pass $gifts_legacy_us;
        }

        ################ Logged and guest user, must go to old site ################
        # Casamiento
        location ~ ^(/casamiento/nuestros-regalos.php|/casamiento/enviar-aviso.php|/casamiento/hace-tu-regalo.php|/casamiento/listado-de-regalos.php)$ {
            proxy_pass $gifts_legacy_us;
        }

        # Teens
        location ~ ^(/teens/nuestros-regalos.php|/teens/enviar-aviso.php|/teens/hace-tu-regalo.php|/teens/listado-de-regalos.php)$ {
            proxy_pass $gifts_legacy_us;
        }

        # Viajes
        location ~ ^(/viajes/nuestros-regalos.php|/viajes/enviar-aviso.php|/viajes/hace-tu-regalo.php|/viajes/listado-de-regalos.php)$ {
            proxy_pass $gifts_legacy_us;
        }

        ################ AdWords links and SEO, must go to new Home ################
        location /index.php {
            rewrite ^ / permanent;
        }

        location ~ ^(/casamiento/index.php|/casamiento/|/casamiento)$ {
            rewrite ^ / permanent;
        }

        location ~ ^(/teens/index.php|/teens/|/teens)$ {
            rewrite ^ / permanent;
        }


        location ~ ^(/viajes/index.php|/viajes/|/viajes)$ {
            rewrite ^ / permanent;
        }

        # Old list type
        location ~ ^(/primer-hogar/index.php|/primer-hogar/|/primer-hogar)$ {
            rewrite ^ / permanent;
        }

        ##################### Assets and AJAX request routes #####################
        location ~ ^(/casamiento/ajax/(.*).php|/ajax-2016/(.*).php|/ajax/(.*).php|/emails/(.*)|/images/(.*)|/img/banners_home/(.*)|/estilos-landing.css|/css/newStyle.css|/js/jquery.countdown.js)$ {
            proxy_pass $gifts_legacy_us;
        }

        ######################### gifts-legacy API #########################
        location /api {
            proxy_pass $gifts_legacy_us;
        }

        ######################### gifts-dashboard #########################
        location /panel {
            proxy_pass $gifts_dashboard_us;
            client_max_body_size 10M;
        }

        location ~ ^(/styles.*|/styles2016.*|/js.*) {
            proxy_pass $gifts_legacy_us;
        }

        ############################ New landings ############################
        location /listado.php {
            # Rewrites /listado.php?lista=360252 to /l/360252
            if ($arg_lista ~ ^(\d+)) {
                rewrite ^ /l/$arg_lista? permanent;
            }
        }
}

# Gifts Public API
server {
        include /etc/nginx/env.conf;
        include /etc/nginx/proxy_env.conf;

        listen 80;
        server_name public-api-ci.garbarino.com public-api-staging.garbarino.com public-api.garbarino.com;
        set $webstore Garbarino;
        # For user multimedia resources upload
        client_max_body_size 10M;

        include /etc/nginx/includes/headers;
        include /etc/nginx/includes/https-only;

        ######################### gifts-core #########################
        location /gifts {
            proxy_pass $gifts_core_us;
            client_max_body_size 10M;
        }

        ######################### oauth2-server #########################
        location /oauth {
            proxy_pass $oauth2_server_us;
        }
}


# Gifts legacy development environments
server {
        include /etc/nginx/env.conf;
        include /etc/nginx/proxy_env.conf;

        listen 80;
        server_name listas-ci.garbarino.com listas-staging.garbarino.com;
        set $webstore Garbarino;

        include /etc/nginx/includes/headers;
        include /etc/nginx/includes/security;

        location /api {
            rewrite ^(.*) /listas-de-regalos$1 break;
            proxy_pass $gifts_legacy_us;
        }
}
