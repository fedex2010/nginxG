machine:
  python:
    version: 2.7.6

dependencies:
  pre:
    - pip install awscli
deployment:
  develop:
    branch: develop
    commands:
      - zip -r app.zip Dockerfile nginx.conf conf.d includes env.conf env.conf.ci env_gen.sh security api
      - aws s3 cp app.zip s3://garbarino-deploys/nginx/builds/$CIRCLE_SHA1-$CIRCLE_BUILD_NUM.zip
      - aws elasticbeanstalk create-application-version --application-name nginx --version-label $CIRCLE_SHA1-$CIRCLE_BUILD_NUM-snapshot --source-bundle S3Bucket=garbarino-deploys,S3Key=nginx/builds/$CIRCLE_SHA1-$CIRCLE_BUILD_NUM.zip --region us-east-1
      - aws elasticbeanstalk update-environment --environment-name nginx-ci --version-label $CIRCLE_SHA1-$CIRCLE_BUILD_NUM-snapshot --region us-east-1
  staging:
    branch: master
    commands:
      - zip -r app.zip Dockerfile nginx.conf conf.d includes env.conf env.conf.staging env.conf.prod env_gen.sh security api
      - aws s3 cp app.zip s3://garbarino-deploys/nginx/builds/$CIRCLE_SHA1-$CIRCLE_BUILD_NUM.zip
      - aws elasticbeanstalk create-application-version --application-name nginx --version-label $CIRCLE_SHA1-$CIRCLE_BUILD_NUM-release --source-bundle S3Bucket=garbarino-deploys,S3Key=nginx/builds/$CIRCLE_SHA1-$CIRCLE_BUILD_NUM.zip --region us-east-1
      - aws elasticbeanstalk update-environment --environment-name nginx-staging --version-label $CIRCLE_SHA1-$CIRCLE_BUILD_NUM-release --region us-east-1